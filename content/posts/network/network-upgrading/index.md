---
title: 家庭网络升级改造
date: 2022-06-20T20:25:00+08:00
lastmod: 2022-08-15T11:12:18+08:00
description: ""
featuredImage: ""
categories:
- network
tags:
- network
---

## 前言

前段时间抛弃了价格还算厚道的移动宽带，换了电信的宽带，终于搞来了我心心念念的公网 IP。也想发挥一下 N1 盒子的性能，没错，我是垃圾佬，公网 IP 都有了，开整！  

## 架构

由于 N1 搭配 clash 的稳定性前段时间也验证过了，所以我决定将 N1 由旁路由升级为主路由。  

下面是我目前在使用的网络架构图

![网络架构](https://cdn.zggsong.cn/2022/06/20/1.png)

虽然 N1 盒子只有一个物理网口，但是可以在逻辑上添加一个 WAN 口，然后逻辑 WAN、LAN 共用一个物理端口。其实有更好的选择，市面上的成品软路由很多，网口也多，x86 架构，还稳定，问就是没钱。另外 N1 性能够用，早知道当初多买点 N1 了，过了几年还成理财产品了。

> 房东这弱电箱，已经被我的三台设备撑得满满当当，好在经过一段时间使用，温度也还好。

![弱电箱](https://cdn.zggsong.cn/2023/03/29/d077ad8abe63a.png)

## OpenWRT

其实 N1 性能完全 OK，直到我在群晖虚拟机上跑过 openwrt 后才清晰地认识到，还有 220+ CPU 好吧只能说将将够用。目前我的 N1 是用的恩山论坛 [flippy](https://www.right.com.cn/forum/space-uid-285101.html) 编译的固件，不过有点洁癖，回头有空根据自己需求重新编译。如果自己编译 OpenWRT 需求的小伙伴，可以看看 [PeterX](https://p3terx.com/archives/build-openwrt-with-github-actions.html) 的这篇文章。

目前 OpenWRT 作为主路由，上面跑了 `拨号` 、 `DHCP` 、 `端口转发` 、 `DDNS` 、 `FRPS` 、 `CLASH` 什么网易云破解，广告拦截，ADGUARD 暂时都不考虑，之前用下来稳定性作为旁路由还好，主路由出点问题还是比较蛋疼的。

## 联动 NAS

前面有说入手了群晖 NAS，自带的服务能够满足公网环境访问，但是考虑到速度，稳定性，还是自建来的香。  

之前通过 frp 反向代理走 `https` 泛域名到 `nas` ，`nas` 上安装泛域名证书，nginx 反向代理，转发到本地网络各设备的 `ip`  + `端口` ，这一套使用下来堪称完美，安全性，稳定性都比较好，平时使用同步文件体验非常棒，唯一蛋疼的就是带宽上限太低。如果通过公网 IP ddns 端口转发 等于又来了一套方案，主要是映射出去不加密，着实不放心。

公网 IP 加上 DDNS 这不就是台速度巨快，性能弹性极大的云服务器嘛，所以我直接在软路由上跑了 `frps` ，原先的域名重新解析到 ddns 的域名上，实现完美无缝迁移，以后如果搬家，改一下域名解析，也能无缝迁移回去。  

![frps](https://cdn.zggsong.cn/2022/06/20/2.png)

---

## 番外

配置好第二天突然发现我的服务全挂了。其中一个是犯了最低级的错误，转发用了公网 8080 端口，这没得说，运营商的宽带，还是尽量避开常用端口。但是我的 frp 的端口死活是不通，测试 n 多遍之后，我发现端口转发出去的都没有限制，所以在针对 frp 又做了一层端口转发，好在是能接着用了/离谱

随后在 clash 魔法的时候，发现 ddns 解析的结果死活拿不到，op 这边一直指向本地，公网查却是可以正常解析，一开始我以为是缓存问题，清了缓存依旧。本地 DNS 解析全部由 `dnsmasq` 接管，问题必然出在这里，所以手动指定域名走指定 DNS 上游服务器  

![dnsmasq](https://cdn.zggsong.cn/2022/06/20/574753c8dba55.png)

> 这里还有一个坑，不清楚是不是固件的问题还是别的啥问题，在 web 这边配置保存不了，一段时间会删除已保存配置
>
> [解决方案](https://github.com/coolsnowwolf/lede/issues/6516) : ssh 连接 `vim /etc/dnsmasq.conf` 在文件末尾 添加 `server=/域名/114.114.114.114（或者其他 dns 服务器）`

改造完成使用了两周，目前一切良好。溜~
